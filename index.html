<!-- Cloudflare Pages 服务端网页界面（纯服务端，带可视化管理） -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Cloudflare WebSocket服务端（带界面）</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 20px; color: #2c3e50; }
        .status-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .status-item { margin: 8px 0; font-size: 16px; }
        .status-value { font-weight: bold; color: #2196f3; }
        .log-box { border: 1px solid #dee2e6; height: 400px; overflow-y: auto; padding: 10px; border-radius: 8px; background: #fff; margin-bottom: 20px; }
        .log-item { margin: 5px 0; padding: 8px; border-radius: 4px; }
        .system-log { background: #e3f2fd; color: #0d47a1; }
        .user-log { background: #f1f8e9; color: #2e7d32; }
        .control-area { display: flex; gap: 10px; align-items: center; }
        #system-msg { flex: 1; padding: 10px; font-size: 16px; border: 1px solid #ddd; border-radius: 4px; }
        #send-system-btn { padding: 10px 20px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-system-btn:hover { background: #1976d2; }
        #refresh-status { padding: 10px 20px; background: #607d8b; color: white; border: none; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <h1 class="header">Cloudflare WebSocket服务端（管理界面）</h1>

    <!-- 服务端状态卡片 -->
    <div class="status-card">
        <div class="status-item">服务端地址：<span class="status-value" id="server-url">wss://ws-chat-server.3316044319.workers.dev</span></div>
        <div class="status-item">当前在线客户端数：<span class="status-value" id="online-count">0</span></div>
        <div class="status-item">服务端运行时间：<span class="status-value" id="server-time">--</span></div>
        <button id="refresh-status">刷新状态</button>
    </div>

    <!-- 服务端日志/消息展示 -->
    <div class="log-box" id="log-box"></div>

    <!-- 服务端发送系统消息 -->
    <div class="control-area">
        <input type="text" id="system-msg" placeholder="输入系统消息发送给所有客户端...">
        <button id="send-system-btn">发送系统消息</button>
    </div>

    <script>
        // 配置：替换为你的Worker域名
        const WORKER_URL = "https://ws-chat-server.3316044319.workers.dev";
        const WS_URL = "wss://ws-chat-server.3316044319.workers.dev";

        // 页面加载后初始化
        window.onload = () => {
            refreshServerStatus(); // 刷新服务端状态
            connectToWebSocket(); // 连接服务端（监听日志）
            bindEvents(); // 绑定按钮事件
        };

        // 刷新服务端状态
        async function refreshServerStatus() {
            try {
                const res = await fetch(`${WORKER_URL}/status`);
                const data = await res.json();
                document.getElementById("online-count").textContent = data.onlineCount;
                document.getElementById("server-time").textContent = data.serverTime;
            } catch (e) {
                addLog(`获取状态失败：${e.message}`, "system");
            }
        }

        // 连接服务端WebSocket（监听日志）
        function connectToWebSocket() {
            const ws = new WebSocket(WS_URL);
            ws.onopen = () => addLog("服务端WebSocket连接成功（监听日志）", "system");
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                // 展示日志
                const logText = data.type === "system" 
                    ? `[${data.time}] 系统：${data.content}（在线：${data.onlineCount}）`
                    : `[${data.time}] ${data.senderIp}：${data.message}`;
                addLog(logText, data.type);
                // 更新在线数
                document.getElementById("online-count").textContent = data.onlineCount;
            };
            ws.onclose = () => {
                addLog("服务端WebSocket连接断开，5秒后重连...", "system");
                setTimeout(connectToWebSocket, 5000); // 重连
            };
            ws.onerror = (e) => addLog(`WebSocket错误：${e.message}`, "system");
        }

        // 绑定按钮事件
        function bindEvents() {
            // 刷新状态按钮
            document.getElementById("refresh-status").addEventListener("click", refreshServerStatus);
            // 发送系统消息按钮
            document.getElementById("send-system-btn").addEventListener("click", sendSystemMessage);
            // 回车发送
            document.getElementById("system-msg").addEventListener("keypress", (e) => {
                if (e.key === "Enter") sendSystemMessage();
            });
        }

        // 发送系统消息
        function sendSystemMessage() {
            const msgInput = document.getElementById("system-msg");
            const msg = msgInput.value.trim();
            if (!msg) return;
            // 连接WebSocket发送系统消息
            const ws = new WebSocket(WS_URL);
            ws.onopen = () => {
                ws.send(`[系统通知] ${msg}`);
                addLog(`[${new Date().toLocaleString()}] 我（服务端）：${msg}`, "system");
                msgInput.value = "";
                ws.close();
            };
            ws.onerror = (e) => addLog(`发送系统消息失败：${e.message}`, "system");
        }

        // 添加日志到界面
        function addLog(text, type) {
            const logBox = document.getElementById("log-box");
            const logItem = document.createElement("div");
            logItem.className = `log-item ${type}-log`;
            logItem.textContent = text;
            logBox.appendChild(logItem);
            logBox.scrollTop = logBox.scrollHeight; // 滚动到底部
        }
    </script>
</body>
</html>
