<!-- 修复后的服务端界面（Pages） -->
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>Cloudflare WebSocket服务端</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
    .status-card { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
    .log-box { border: 1px solid #ddd; height: 400px; overflow-y: auto; padding: 10px; border-radius: 8px; margin-bottom: 20px; }
    .log-item { margin: 5px 0; padding: 8px; border-radius: 4px; }
    .system-log { background: #e3f2fd; }
    .user-log { background: #f1f8e9; }
  </style>
</head>
<body>
  <h1>Cloudflare WebSocket服务端</h1>
  <div class="status-card">
    <p>服务端地址：<span id="server-url">wss://ws-chat-server.3316044319.workers.dev</span></p>
    <p>当前在线数：<span id="online-count">0</span></p>
    <p>服务端时间：<span id="server-time">--</span></p>
    <button onclick="refreshStatus()">刷新状态</button>
  </div>
  <div class="log-box" id="log-box"></div>
  <div>
    <input type="text" id="sys-msg" placeholder="输入系统消息">
    <button onclick="sendSysMsg()">发送</button>
  </div>

  <script>
    const WS_URL = "wss://ws-chat-server.3316044319.workers.dev";
    const API_URL = "https://ws-chat-server.3316044319.workers.dev/status";

    // 页面加载后初始化
    window.onload = () => {
      refreshStatus();
      connectWs();
    };

    // 刷新状态（调用Worker的/status接口）
    async function refreshStatus() {
      try {
        const res = await fetch(API_URL);
        const data = await res.json();
        document.getElementById("online-count").textContent = data.onlineCount;
        document.getElementById("server-time").textContent = data.serverTime;
      } catch (e) {
        addLog(`获取状态失败：${e.message}`, "system");
      }
    }

    // 连接WebSocket
    function connectWs() {
      const ws = new WebSocket(WS_URL);
      ws.onopen = () => addLog("已连接到服务端", "system");
      ws.onmessage = (e) => {
        const data = JSON.parse(e.data);
        addLog(`[${data.time}] ${data.type === 'system' ? '系统' : data.senderIp}：${data.content}`, data.type);
        document.getElementById("online-count").textContent = data.onlineCount;
      };
      ws.onclose = () => {
        addLog("连接断开，5秒后重连", "system");
        setTimeout(connectWs, 5000);
      };
      ws.onerror = (e) => addLog(`WebSocket错误：${e.message || '未知错误'}`, "system");
    }

    // 发送系统消息
    function sendSysMsg() {
      const msg = document.getElementById("sys-msg").value.trim();
      if (!msg) return;
      const ws = new WebSocket(WS_URL);
      ws.onopen = () => {
        ws.send(msg);
        addLog(`[${new Date().toLocaleString()}] 系统：${msg}`, "system");
        document.getElementById("sys-msg").value = "";
        ws.close();
      };
    }

    // 添加日志
    function addLog(text, type) {
      const logBox = document.getElementById("log-box");
      const div = document.createElement("div");
      div.className = `log-item ${type}-log`;
      div.textContent = text;
      logBox.appendChild(div);
      logBox.scrollTop = logBox.scrollHeight;
    }
  </script>
</body>
</html>
